networks:
  analytics-net:
    driver: bridge

services:
  # 1. DATA SOURCE
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    networks:
      - analytics-net
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: production_password
      POSTGRES_DB: main_db
    command: ["postgres", "-c", "wal_level=logical", "-c", "max_replication_slots=4"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d main_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. MESSAGE BUS
  redpanda:
    image: docker.redpanda.com/redpandadata/redpanda:v23.2.1
    container_name: redpanda
    networks:
      - analytics-net
    command: >
      redpanda start 
      --overprovisioned 
      --smp 1 
      --memory 1G 
      --reserve-memory 0M 
      --node-id 0 
      --check=false
      --kafka-addr PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
      --advertise-kafka-addr PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092
    healthcheck:
      test: ["CMD", "rpk", "cluster", "info", "--brokers", "redpanda:29092"]
      interval: 5s
      timeout: 10s
      retries: 5

  # 3. CDC ENGINE
  connect:
    image: debezium/connect:2.4
    container_name: connect
    networks:
      - analytics-net
    depends_on:
      redpanda:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      BOOTSTRAP_SERVERS: redpanda:29092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: _connect_configs
      OFFSET_STORAGE_TOPIC: _connect_offsets
      STATUS_STORAGE_TOPIC: _connect_statuses
      CONFIG_STORAGE_REPLICATION_FACTOR: 1
      OFFSET_STORAGE_REPLICATION_FACTOR: 1
      STATUS_STORAGE_REPLICATION_FACTOR: 1
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
    healthcheck:
      test: ["CMD", "curl", "-f", "http://connect:8083/connectors"]
      interval: 10s
      timeout: 5s
      retries: 5

  # 4. OLAP DATABASE
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    networks:
      - analytics-net
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - ./ch-init:/docker-entrypoint-initdb.d
    environment:
      CLICKHOUSE_USER: admin
      CLICKHOUSE_PASSWORD: production_password
      CLICKHOUSE_DB: main_db
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "clickhouse:8123/ping"]
      interval: 5s

  # 5. AUTOMATION & SIMULATION
  pipeline-setup:
    image: curlimages/curl:latest
    container_name: pipeline-setup
    networks:
      - analytics-net
    depends_on:
      connect:
        condition: service_healthy
    volumes:
      - ./debezium-config.json:/config.json
    entrypoint: 
      - /bin/sh
      - -c
      - |
        echo "Waiting for Debezium API..."
        until curl -s -o /dev/null -w "%{http_code}" http://connect:8083/connectors | grep -q "200"; do
          sleep 2
        done
        echo "Injecting Debezium Configuration..."
        curl -i -X POST -H "Content-Type:application/json" -d @/config.json http://connect:8083/connectors/

  simulator:
    build: ./simulator
    container_name: simulator
    networks:
      - analytics-net
    depends_on:
      postgres:
        condition: service_healthy

  # 6. USER INTERFACES
  redpanda-console:
    image: docker.redpanda.com/redpandadata/console:latest
    container_name: redpanda-console
    networks:
      - analytics-net
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo "kafka: { brokers: ['redpanda:29092'] }" > /tmp/config.yml
        /app/console --config.filepath=/tmp/config.yml
    ports:
      - "8081:8080"
    depends_on:
      redpanda:
        condition: service_healthy

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin
    networks:
      - analytics-net
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    depends_on:
      postgres:
        condition: service_healthy

  clickhouse-ui:
    image: spoonest/clickhouse-tabix-web-client
    container_name: clickhouse-ui
    networks:
      - analytics-net
    ports:
      - "8082:80"
    depends_on:
      clickhouse:
        condition: service_healthy

  datalens:
    image: ghcr.io/datalens-tech/datalens-ui:latest
    container_name: datalens
    networks:
      - analytics-net
    ports:
      - "8080:8080"
    depends_on:
      clickhouse:
        condition: service_healthy